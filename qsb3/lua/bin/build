#!/bin/bash

# build unifile qsb
rm -rf ../var/*
mkdir ../var/qsb
lua writer.lua
cp ../var/qsb.lua ../var/qsb/qsb.lua
cd ../../luaminifyer
./LuaMinify.sh ../lua/var/qsb.lua
cp ../var/qsb_min.lua ../var/qsb/qsb_min.lua
cd ../lua
# rm var/qsb/qsb.lua
# mv var/qsb/qsb_min.lua var/qsb/qsb.lua

# build documentation
cd ../ldoc
lua ldoc.lua -d ../doc/html ../lua/modules
cd ../lua/bin
lua docbuilder.lua
rm -rf ../../doc/html/js
cp -r ../tpl/js ../../doc/html
rm -rf ../../doc/html/css
cp -r ../tpl/css ../../doc/html

# create archive
cd ../var
cp -r ../../default/mapscript.lua qsb/mapscript.lua
cp -r ../../default/localmapscript.lua qsb/localmapscript.lua
cp -r ../../doc qsb
mkdir -p qsb/src/modules
cp -r ../modules/* qsb/src/modules
zip -r -o qsb/* qsb/src/* qsb/doc/* &>/dev/null
rm -rf qsb/doc
rm -rf qsb/src
mv qsb/doc.zip qsb.zip

# copy to shipment repo
cd ../..
mkdir --parents Swift/modules
rm -rf Swift/modules/*
cp -r lua/modules/* Swift/modules
mkdir --parents Swift/default
rm -rf Swift/default/*
cp -r default/* Swift/default
mkdir --parents Swift/doc
rm -rf Swift/doc/*
cp -r doc/* Swift/doc